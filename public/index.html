<!DOCTYPE html>
<html lang="en">
<head>

    <!-- 列を削除するぼらん -->
    <!-- 設定も削除するぼらん -->
    <!-- ブラウザ内で履歴を保存するボタン -->
    <!-- 色も追加 -->
    <!-- 一位の人に往還を付与 -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fontawesome.com/icons/arrow-right-to-bracket?f=classic&s=solid">

    <meta charset="UTF-8">
    <title>Dynamic Table with Input Fields</title>
    <style>
    table {
        width: 100%; /* テーブルの幅をウィンドウ幅いっぱいに設定 */
        table-layout: fixed; /* 列幅を均等に分配 */
        border-collapse: collapse; /* ボーダーの重複をなくす */
    }

    th, td {
        /*border: 1px solid black;*/ /* セルに境界線を設定 */
        text-align: center; /* テキストを左揃えに設定 */
        /*padding: 8px;*/ /* セルの内側の余白を設定 */
    }

    input {
        text-align: center;
        width: 70%; /* セルの幅に合わせてinputの幅を設定 */
        box-sizing: border-box; /* パディングとボーダーを含む総幅を100%にする */
        border: none; /* 枠線を消す */
        outline: none; /* フォーカス時のアウトラインを消す */
        background-color: transparent;
        font-size: 1.3rem; /* 文字サイズを大きくする */
    }

    .button-group {
        border: 2px solid #007bff; /* 青色の枠線 */
        padding: 5px; /* 内側の余白 */
        margin: 5px; /* 外側の余白 */
        border-radius: 10px; /* 角の丸み */
        display: inline-block; /* グループをコンテンツのサイズに合わせる */
    }

    button {
        max-width: 100%; /* セルの幅を超えないように制限 */
        max-height: 100%; /* セルの高さを超えないように制限 */
        background-color: #007bff; /* 青色の背景 */
        color: white; /* テキストは白色 */
        padding: 5px 5px; /* パディングでボタンのサイズを調整 */
        border: none; /* 枠線は非表示 */
        border-radius: 5px; /* 角を丸くする */
        cursor: pointer; /* カーソルをポインタにする */
        margin-right: 5px; /* ボタン間に隙間を設ける */
        margin-bottom: 3px;
        overflow: hidden; /* 内容がオーバーフローした場合に何をするか */
        text-overflow: ellipsis; /* オーバーフローしたテキストを...で表示 */
        white-space: nowrap; /* 改行を無視して、一行で表示 */
        box-sizing: border-box; /* パディングとボーダーを含む総幅を100%にする */
    }

        button:hover {
            background-color: #0056b3; /* ホバー時には背景色を少し暗くする */
        }

    .delete-btn {
        max-width: none; /* セルの幅制限を解除 */
        max-height: none; /* セルの高さ制限を解除 */
        background-color: transparent; /* 背景色を透明に */
        color: inherit; /* 色を継承する */
        padding: 3; /* パディングをなしに */
        overflow: visible; /* オーバーフローを表示 */
        border-radius: 0; /* 角を丸くしない */
        margin-right: 0; /* 余白をなしに */
        /* 他に必要なスタイルがあればここに追加 */
    }

        .delete-btn:hover {
            background-color: #d1dcf1; /* ホバー時には背景色を少し暗くする */
        }

    input:focus {
        outline: none;
        border-bottom: 2px solid #007bff; /* フォーカス時にアンダーラインを強調 */
        background-color: #eef4ff; /* フォーカス時に背景色を変更 */
    }

    input[type="text"]:focus::placeholder {
        color: transparent; /* フォーカス時にplaceholderを隠す */
    }

    .large-text {
        font-size: 1.5rem; /* 文字サイズを大きくする */
    }

    .icon-background-cell {
        background-image: url('./images/crown-solid.svg'); /* アイコンのパス */
        background-size: contain; /* セルに収まるように調整 */
        background-repeat: no-repeat; /* 繰り返しを無しに */
        margin: 20px; /* 外側の余白 */
        background-position: center; /* 中央に配置 */
    }
</style>
</head>
<body>
    <!-- <button onclick="addRow()">Add Row</button>
    <button onclick="addColumn()">Add Column</button>-->
    <div class="button-group">
        Clear : 
    <button onclick="clearPoints()">Points</button>
        <button onclick="clearPointsCategpries()">PointsCategpries</button>
        <button onclick="clearNames()">Names</button>
        <button onclick="clearAll()">All</button>

    </div>
    <button id="resetButton" onclick="resetButton()">Reset</button>
    <!--<button id="saveButton" onclick="saveButton()">Save</button>-->


    <table id="myTable" border="1">
        <tr>
            <th>
                <input type="text" name="header1" placeholder="Title" class="large-text">
                <br>
                <button onclick="addRow()"><i class="fa fa-solid fa-arrow-right-to-bracket fa-rotate-90"></i>Row</button>
                <button onclick="addColumn()"><i class="fa fa-duotone fa-arrow-right-to-bracket"></i>COL</button>

            </th>
            <th >
                <!--<i class="fa fa-solid fa-crown fa-flip" style="color: #eabd1a;"></i>-->
                <input type="text" name="header1" placeholder="name Ash">
                <button class="delete-btn" onclick="removeColumn(this)"><i class="fas fa-trash"></i></button>
            </th>
            <th>
                <input type="text" name="header2" placeholder="name Bob">
                <button class="delete-btn" onclick="removeColumn(this)"><i class="fas fa-trash"></i></button>
            </th>

        </tr>
        <tr>
            <td>
                <input type="text" name="column1[]" placeholder="Victory Point">
                <button class="delete-btn" onclick="removeRow(this)"><i class="fas fa-trash"></i></button>
            </td>
            <td>
                <input type="number" name="column2[]" placeholder="0点"></td>
            <td>
                <input type="number" name="column3[]" placeholder="0点"></td>

        </tr>
        <tr>
            <td>
                <input type="text" name="column1[]" placeholder="VP">
                <button class="delete-btn" onclick="removeRow(this)"><i class="fas fa-trash"></i></button>
            </td>
            <td>
                <input type="number" name="column2[]" placeholder="0点"></td>
            <td>
                <input type="number" name="column3[]" placeholder="0点"></td>

        </tr>
        <tr>
            <td>集計</td>
            <td class="totalCell">
                <input type="text" name="column1[]" value="0点"></td>
            <td class="totalCell">
                <input type="text" name="column2[]" value="0点"></td>

        </tr>
    </table>

    <script>

    let names = ["ash", "bob", "carol", "denis", "elen", "fishbarg", "godon", "hank", "incal", "jack", "keanu", "leon", "muadive", "neel", "oppo", "prin", "queen", "ruby", "sin", "tarou", "u r me", "viran", "wick", "xian", "yell", "zack"];

    function addRow() {
        var table = document.getElementById("myTable");
        var rowCount = table.rows.length; // 合計行を含む行数
        var newRow = table.insertRow(rowCount - 1); // 合計行の前に新しい行を追加
        var columnCount = table.rows[0].cells.length; // 列の数を取得

        for (var i = 0; i < columnCount; i++) {
            var cell = newRow.insertCell(i);
            if (i === 0) {
                // 最初のセルに行削除ボタンを追加
                cell.innerHTML = `<input type="text" name="column${i}[]"  placeholder="VP" ><button class="delete-btn" onclick="removeRow(this)"><i class="fas fa-trash"></i></button>`;
            } else {
                // その他のセルに入力フィールドを追加
                cell.innerHTML = `<input type="number" name="column${i}[]" oninput="updateSum()" placeholder="0点" ">`;
            }
        }
        saveTableData();
    }



    function addColumn() {
        var table = document.getElementById("myTable");
        var rows = table.rows;
        var columnCount = rows[0].cells.length; // 現在の列の数

        // ヘッダー行に新しいヘッダーセルを追加
        var headerCell = document.createElement("th");
        var headerName = names[columnCount % names.length] || `Column ${columnCount}`;
        headerCell.innerHTML = `<input type="text" name="column${columnCount}[]" placeholder="${headerName}" ">
                            <button class="delete-btn" onclick="removeColumn(this)"><i class="fas fa-trash"></i></button>`;

        rows[0].appendChild(headerCell);

        // 各データ行に新しいセルを追加
        for (var i = 1; i < rows.length; i++) { // 合計行も含める
            var newCell = rows[i].insertCell(-1);
            if (i < rows.length - 1) {
                newCell.innerHTML = `<input type="number" name="column${columnCount}[]" placeholder="0点" oninput="updateSum()" ">`;
            } else {
                // 合計行に新しいセルを追加
                newCell.className = "totalCell";
                newCell.innerHTML = "0点";
            }
        }
        saveTableData();

    }



    function updateSum() {
        var table = document.getElementById("myTable");
        var rows = table.rows;
        var columnTotals = [];

        for (let colIndex = 1; colIndex < rows[0].cells.length; colIndex++) {
            rows[0].cells[colIndex].classList.remove("icon-background-cell");
            let total = 0;
            for (let rowIndex = 1; rowIndex < rows.length - 1; rowIndex++) {
                let cell = rows[rowIndex].cells[colIndex];
                let input = cell.querySelector('input[type="number"]');
                if (input) {
                    total += parseFloat(input.value) || 0;
                }
            }
           columnTotals.push(total);

            let totalCells = table.querySelectorAll('.totalCell');
            if (totalCells && totalCells.length >= colIndex) {
                totalCells[colIndex - 1].textContent = total + '点';
            }
        }
        if (!columnTotals.every(value => value === 0)) {
            // 最も高い合計を見つける
            let highestTotal = Math.max(...columnTotals);

            // 最高値と等しい全ての列にクラスを追加
            columnTotals.forEach((total, index) => {
                if (total === highestTotal) {
                    rows[0].cells[index + 1].classList.add("icon-background-cell");
                }
            });
        }
        saveTableData();
     
    }




    // 行または列の入力値が変更されたときに合計を更新するための関数を呼び出す
    function addInputEventListeners() {
        var table = document.getElementById("myTable");
        var inputs = table.querySelectorAll('input[type="number"]'); // 数値入力フィールドに限定

        inputs.forEach(function (input) {
            input.removeEventListener('input', updateSum); // 既存のリスナーを削除
            input.addEventListener('input', updateSum); // 新しいリスナーを追加
        });

    }


    function clearPoints() {
        var table = document.getElementById("myTable");
        for (var i = 1; i < table.rows.length; i++) { // 合計行を除外
            for (var j = 1; j < table.rows[i].cells.length; j++) { // 最初の列を除外
                var cell = table.rows[i].cells[j];
                var input = cell.getElementsByTagName('input')[0];
                if (input) {
                    input.value = ''; // 値をクリア
                }
            }
        }
        updateSum();
    }
    function clearPointsCategpries() {
        var table = document.getElementById("myTable");
        for (var i = 1; i < table.rows.length; i++) { // 合計行を除外
            var cell = table.rows[i].cells[0];
            var input = cell.getElementsByTagName('input')[0];
            if (input) {
                input.value = ''; // 値をクリア
            }
        }
        saveTableData();

    }

    function clearNames() {
        var table = document.getElementById("myTable");
        for (var j = 1; j < table.rows[0].cells.length; j++) { // 最初の列を除外
            var cell = table.rows[0].cells[j];
            var input = cell.getElementsByTagName('input')[0];
            if (input) {
                input.value = ''; // 値をクリア
            }
        }
        updateSum();
    }
    function clearAll() {
        var table = document.getElementById("myTable");
        for (var i = 0; i < table.rows.length; i++) { // 合計行を除外
            for (var j = 0; j < table.rows[i].cells.length; j++) { // 最初の列を除外
                var cell = table.rows[i].cells[j];
                var input = cell.getElementsByTagName('input')[0];
                if (input) {
                    input.value = ''; // 値をクリア
                }
            }
        }
        updateSum();
    }



    function removeColumn(button) {
        var table = document.getElementById("myTable");
        var columnIndex = button.closest('td, th').cellIndex; // 正しい列インデックスを取得
        //var columnIndex = button.parentNode.cellIndex;

        for (var i = 0; i < table.rows.length; i++) {
            table.rows[i].deleteCell(columnIndex);
        }
        saveTableData();

    }

    function removeRow(button) {
        var row = button.parentNode.parentNode;
        var rowIndex = row.rowIndex;
        document.getElementById("myTable").deleteRow(rowIndex);
        saveTableData();

    }



    function saveTableData() {
        var tableData = document.getElementById("myTable").innerHTML;
        var storedData = localStorage.getItem("tableData");
        var tableDataArray = storedData ? JSON.parse(storedData) : [];

        if (tableDataArray.length === 0) {
            tableDataArray.push(tableData);  // 初期状態を保存
        }

        tableDataArray[1] = tableData;  // 変更後の状態を保存
        console.log("tableDataArray[1]"+tableDataArray[1])

        localStorage.setItem("tableData", JSON.stringify(tableDataArray));
    }


    // リセットボタンの機能
    function resetButton(button) {
        var storedData = localStorage.getItem("tableData");
        if (storedData) {
            var tableDataArray = JSON.parse(storedData);
            document.getElementById("myTable").innerHTML = tableDataArray[0]; // 初期状態に戻す

            // 変更後の状態をリセット
            tableDataArray[1] = tableDataArray[0];
            localStorage.setItem("tableData", JSON.stringify(tableDataArray));

            updateSum(); // 合計を更新
            addInputEventListeners(); // イベントリスナーを再設定
        }
        saveTableData();

    }



function loadTableData() {
    var storedData = localStorage.getItem("tableData");
    if (storedData) {
        var tableDataArray = JSON.parse(storedData);
        console.log("tableDataArray"+tableDataArray)
        var currentTableData = tableDataArray[1] || tableDataArray[0];
        document.getElementById("myTable").innerHTML = currentTableData;
    }
}

    // ページ読み込み後にイベントリスナーを追加
    window.onload = function () {

        saveTableData();
        loadTableData();
        addInputEventListeners();
    };


    </script>
</body>
</html>
